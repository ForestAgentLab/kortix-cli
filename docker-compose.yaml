version: '3.8'

services:
  kortix-cli:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: kortix-cli
    
    # 环境变量
    environment:
      # 阿里云百炼 API Key（必需）
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}
      # Tavily 搜索 API Key（可选）
      - TAVILY_API_KEY=${TAVILY_API_KEY:-}
      # 工作区目录
      - WORKSPACE_DIR=/app/data/workspace
    
    # 挂载 Docker socket（用于沙箱执行）
    volumes:
      # Docker-in-Docker: 挂载宿主机 Docker socket
      - /var/run/docker.sock:/var/run/docker.sock
      # 持久化数据
      - ./data/conversations:/app/data/conversations
      - ./data/workspace:/app/data/workspace
      # 配置文件（可选，如需自定义）
      - ./config.yaml:/app/config.yaml
    
    # 网络模式
    network_mode: bridge
    
    # 交互式终端
    stdin_open: true
    tty: true
    
    # 重启策略
    restart: unless-stopped
    
    # 资源限制（可选）
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 512M

  # 可选：Python 沙箱镜像预拉取
  sandbox-python:
    image: python:3.11-slim
    command: python --version
    profiles:
      - setup

  # 可选：Node.js 沙箱镜像预拉取
  sandbox-node:
    image: node:20-slim
    command: node --version
    profiles:
      - setup

# 网络配置
networks:
  default:
    name: kortix-network
    driver: bridge

# 数据卷
volumes:
  conversations:
    driver: local
  workspace:
    driver: local
